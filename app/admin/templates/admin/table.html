{% extends "admin/layout.html" %}
{% from 'bootstrap/modals.html' import render_modal_form, render_confirmation_modal %}

{% block title_button %}
<button id="addButton" data-bs-toggle="modal" data-bs-target="#formModal" data-action="{{ url }}" data-method="POST" class="btn btn-primary" type="button">Add {{ table_name }}</button>
{% endblock %}

{% block content %}

{{ render_modal_form(table_name, form, modal_id='formModal', form_id='form', left_button_id='deleteButton', left_button_text='Delete', left_button_class='btn-danger') }}

<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Delete {{ table_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this {{ table_name.lower() }}?</p>
            </div>
            <div class="modal-footer">
                <button onclick="$(this).trigger('rejected.bs.modal')" type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">No</button>
                <button onclick="$(this).trigger('accepted.bs.modal')" type="button" class="btn btn-danger"
                    data-bs-dismiss="modal">Yes</button>
            </div>
        </div>
    </div>
</div>

<table 
    id="table"
    data-toggle="table"
    data-height="550"
    data-ajax="getItems"
    data-data-field="items"
    data-total-field="total"
    data-side-pagination="server"
    data-query-params="queryParams"
    data-pagination="true"
    data-search="true">
    <thead>
        <tr>
            {% for column in columns %}
            <th data-field="{{ column }}">{{ column.capitalize() }}</th>
            {% endfor %}
            <th data-formatter="actionFormatter">Actions</th>
        </tr>
    </thead>
</table>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="/static/scripts/modalform.js"></script>
<script>

    // Creates the elements for the "Actions" column in the airport table
    function actionFormatter(value, row, index, field) {
        return `<button 
                    class="btn" 
                    type="button" 
                    data-bs-toggle="modal" 
                    data-bs-target="#formModal"
                    data-action="{{ url }}/${row.id}"
                    data-method="PATCH"
                    {% for column in columns %}
                    data-{{ column }}="${row.{{column}}}"
                    {% endfor %}>
                        <i class="bi bi-pencil"></i>
                </button>`
    }

    // Gets the airports from the API and formats the data for Bootstrap Table
    // https://examples.bootstrap-table.com/#options/table-ajax.html#view-source
    function getItems(params) {
        var url = "{{ url }}"
        $.get(url + '?' + $.param(params.data)).then(function (res) {
            // Bootstrap Table expects a total number of items 
            // so it can calculate how many pages and a list of items.
            params.success({total: res._meta.total_items, items: res.items})
        })
    }

    // Bootstrap Table uses limit and offset but our API uses pages and page size.
    // Convert the limit and and offset to our pages and page size.
    // https://examples.bootstrap-table.com/#options/query-params.html#view-source
    function queryParams(params) {
        page = params.offset / params.limit
        return {
            page: page + 1,
            per_page: params.limit,
            search: params.search
        }
    }

    $(document).ready(function () {
        const $form = $('#form')

        const $formModal = $('#formModal')
        const formModal = bootstrap.Modal.getOrCreateInstance($formModal[0])

        const $confirmationModal = $('#confirmationModal')
        const confirmationModal = bootstrap.Modal.getOrCreateInstance($confirmationModal[0])

        const $table = $('#table')

        // Automatically populate form info like method and action
        // based on data attributes from the button that triggered
        // the modal show event.
        $('.modal').modalform();

        $formModal.on('show.bs.modal', function(event) {
            $form.removeClass('was-validated')
            // Hide the delete button on the modal if the user is adding a new airport
            if (event.relatedTarget === $('#addButton')[0]) {
                $('#deleteButton').hide()
            } else {
                $('#deleteButton').show()
            }
        })

        $('#deleteButton').click(function() {
            formModal.hide()
            confirmationModal.show()

            $confirmationModal.one('accepted.bs.modal', function(event) {
                $form.attr('method', 'DELETE')
                $form.submit()
            })

            $confirmationModal.one('rejected.bs.modal', function(event) {
                formModal.show();
            })

            $confirmationModal.on('hidden.bs.modal', function() {
                $confirmationModal.off('accepted.bs.modal');
                $confirmationModal.off('rejected.bs.modal');
            })
        })

        // Handle form validation as per Bootstrap docs
        // https://getbootstrap.com/docs/5.1/forms/validation/#custom-styles
        $('form.needs-validation').submit(function(event) {
            const $form = $(this);
            event.preventDefault()
            if (this.checkValidity() === false) {
                event.stopPropagation()
            } else {
                const data = new FormData(this)
                const value = Object.fromEntries(data.entries())
                const action = $form.attr('action')
                const method = $form.attr('method')
                // TODO: Figure out how to deal with server side form errors.
                // For example submitting an airport with the same code.
                $.ajax({
                    headers : {
                        'Accept' : 'application/json',
                        'Content-Type' : 'application/json'
                    },
                    url : action,
                    type : method,
                    data : JSON.stringify(value),
                    success : function(response, textStatus, jqXhr) {
                        formModal.hide()
                        $table.bootstrapTable('refresh')
                    },
                    error : function(jqXHR, textStatus, errorThrown) {
                        const response = jqXHR.responseJSON
                        if ('errors' in response) {
                            const errors = response.errors
                            for (const property in errors) {
                                const $field = $form.find(`#${property}`)
                                const $feedback = $(`#${property}-feedback`)
                                $field.one('change', function(event) {
                                    $field[0].setCustomValidity("")
                                    $field.removeClass('is-invalid')
                                    $feedback.text('')
                                })
                                $field.addClass('is-invalid')
                                $field[0].setCustomValidity(errors[property])
                                $feedback.text(errors[property])
                            }
                        }
                    },
                    complete : function() {
                        
                    }
                })
            }
            $form.addClass('was-validated')
        })
    })
</script>
{% endblock %}